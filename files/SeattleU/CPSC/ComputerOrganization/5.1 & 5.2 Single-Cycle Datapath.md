#ComputerOrganization 


### Introduction to Microarchitecture

#### Processor as a Finite State Machine (FSM)
![[image-11.png|586x352]]
![[image-12.png|587x454]]

#### Datapath and Control
It is common to decompose the system in two parts:
1) **Datapath:** A collection of interconnected modules that perform all the relevant computation on the data.
	- For a CPU: Set of components that perform arithmetic operations and hold data.
2) **Control Unit:** Coordinates the behavior of the datapath by issuing appropriate control signals.
	- For a CPU: Command the datapath, memory, I/O devices, according to the current instruction.

### ANNA Datapath (Compute Building Blocks)

#### Assumptions
- Datapath will omit these instructions:
	- `jalr`: left as an exercise
	- `in`, `out`: requires special I/O hardware
- Ignore startup: Assume registers, memory, and PC have proper initial state.
- Initial datapath will be single cycle. Each instruction takes one cycle to execute.

#### **ALU**
![[image-13.png|571x398]]
- For `lui` instructions:
	- `IN1` contains current value of $R_D$ (for lower 8 bits)
	- `IN2` contains immediate
- For `lli` instructions:
	- `IN1` is ignored
	- `IN2` contains immediates

#### **Adder**
![[image-14.png|265x136]]
- Adder only adds numbers

#### **Sign Extension**
![[image-15.png|285x62]]
- Sign extension converts smaller number into 16-bit number by extending sign

#### **Branch Detection**
![[image-16.png|284x178]]
- Branch detection unit determines if a branch should be taken or not.
	- `1`: Take branch
	- `0`: Do not take branch or was not a branch (continue to $PC+1$)
![[image-17.png|449x262]]

#### **Register File**
![[image-18.png|226x284]]
- Contains 8 16-bit registers.
- Always enabled (can always read data).
- Can read two values (`Src1`, `Src2`).
	- `Src1` and `Src2` contain register numbers.
- Instruction that write to a register:
	- Set `WEn` (write enable) to `1`
	- `Data` input contains data to write to register.
	- `Dest` input contains register number to write to. (Destination)
	- Writes at end of cycle.
- Instructions that do not write to a register:
	- Set `WEn` (write enable) to `0`.
	- `Data` and `Dest` inputs are ignored

#### **Instruction Memory**
![[image-19.png|219x257]]
- Two separate memories:
	1) One for instructions
	2) One for data
- Instruction memory is always enabled and can only read
- Ignore case where code uses value written to data memory
	- No self-modifying code
- Will be replaced with caches later
	- Instruction and data caches are separate

#### **Data Memory**
![[image-20.png|195x393]]
- For `lw` instructions (read memory):
	- `En` (enable) is set to `1`
	- `R/W` (read/write) is set to `0`
	- `Addr` input contains address of cell to read
	- `Data` input is ignored (not used)
	- `Output` is not used
- For all other instructions:
	- `En` (enable) is set to `0`.
	- All other inputs and the output are ignored (not used).